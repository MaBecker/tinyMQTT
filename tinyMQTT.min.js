(function(){var a,m=function(b,c){c=c||{};a=this;a.svr=b;a.prt=c.port||1883;a.ka=c.keep_alive||60;a.usr=c.username;a.pwd=c.password;a.cn=0;a.ri=c.reconnect_interval||2E3;a.wt=c.will_topic;a.wp=c.will_payload||""},g=m.prototype,e=String.fromCharCode,h=b=>b&&clearInterval(b),n=b=>{if(3===b.charCodeAt(0)>>4){var c=b.length,f=b.charCodeAt(1),k=b.charCodeAt(2)<<8|b.charCodeAt(3);a.emit("message",{topic:b.substr(4,k),message:b.substr(4+k,f-k-2)});c>f+2&&n(b.substr(f+2,c-f))}},d=
b=>e(b.length>>8,b.length&255)+b,l=(b,c,f)=>e(b,c.length+f.length)+c+f,p=b=>{var c=0;b=d(b);a.wt&&(c|=36,b+=d(a.wt)+d(a.wp));a.usr&&a.pwd&&(c|=192,b+=d(a.usr)+d(a.pwd));return l(16,d("MQTT")+e(4,c,a.ka>>8,a.ka&255),b)};g._sCd=()=>{a.con=h(a.con);a.x1=h(a.x1);a.cn=0;delete a.cl;a.emit("disconnected")};g.connect=()=>{a.cn&&a.con||(a.con=setInterval(()=>{a.cl&&(a.cl.end(),delete a.cl);try{a.cl=require("net").connect({host:a.svr,port:a.prt},()=>{a.con=h(a.con);try{a.cl.write(p(getSerial())),a.emit("connected"),
a.cn=1,a.x1=setInterval(()=>a.cn&&a.cl.write(e(192,0)),a.ka<<10),a.cl.on("data",n),a.cl.on("end",a._sCd)}catch(b){a._sCd()}})}catch(b){a._sCd()}},a.ri))};g.subscribe=b=>{a.cl.write(l(130,e(256,1),d(b)+e(0)))};g.publish=(b,c)=>{if(127<b.length+c.length)throw"tMQTT-TL";a.cn&&(a.cl.write(l(49,d(b),c)),a.emit("published"))};g.disconnect=()=>{if(a.cn)try{a.cl.write(e(224,0))}catch(b){a._sCd()}};exports.create=(b,c)=>new m(b,c)})()